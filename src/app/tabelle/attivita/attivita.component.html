<p-toast key="clToast" styleClass="clToast"></p-toast>
<p-toast key="errorToast" styleClass="errorToast" position="center" ></p-toast>
<p-table #dt
    [lazy]="true"
    (onLazyLoad)="handleEvent('onLazyLoad', $event)"
    [value]="attivita"
    [columns]="doNotShowAziendaHeader(cols)"
    [paginator]="true"
    [rows]="LOADED_ROWS"
    [autoLayout]="true"
    [responsive]="true"
    [totalRecords]="totalRecords"
    selectionMode="single"
    (onRowSelect)="handleEvent('onRowSelect', $event)"
    [scrollable]="true"
    [loading]="loading"
    (keydown.arrowdown)="onKeydownHandlerArrowDown($event)"
    (keydown.arrowup)="onKeydownHandlerArrowUp($event)"
    [(contextMenuSelection)]="attivitaSelezionata" [contextMenu]="cm"
    >
    <ng-template pTemplate="header" let-columns>
        <tr>
            <th tabindex="0" [id]="col.field || col.label" *ngFor="let col of columns"  [style.display]="col.display"
                [style.width]="col.width" [style.minWidth]="col.minWidth" [style.padding]="col.padding" 
                attr.aria-label="Colonna {{col.label}}, {{col.header ? 'Ordinare colonna' : ''}}"
                [pSortableColumn]="col.field" scope="colgroup">
                    {{col.header}}
                <p-sortIcon *ngIf="col.field != undefined && col.field !== 'azione' && col.field !== 'anteprima'" [field]="col.field" attr.aria-label="Ordinare colonna {{col.label}}" arialabelasc="Ordinamento ascendente" arialabeldesc="Ordinamento discendente">
                    <!-- ariaLabelAsc="Colonna {{col.header}}, Ordinamento ascendente" ariaLabelDesc="Colonna {{col.header}}, Ordinamento discendente" -->
                </p-sortIcon>
            </th>
        </tr>
        <tr>
            <td *ngFor="let col of columns" [ngSwitch]="col.filterWidget" class="filters-styles" [style.width]="col.width" [style.minWidth]="col.minWidth" [style.display]="col.display">
                <div *ngIf="col.field != undefined && col.field !== 'azione' && col.field !== 'priorita' && col.field !== 'anteprima'">
                    <p-calendar #calGen *ngSwitchCase="'Calendar'" [(ngModel)]="dataRange[col.field]" placeholder="Scegli..." showButtonBar="true"
                        [locale]="localIt" [showIcon]="false" dateFormat="dd/mm/yy" (onSelect)="onCalendarAction($event, col.field, 'select')"
                        (onClearClick)="onCalendarAction($event, col.field, 'clear')" (onTodayClick)="onCalendarAction($event, col.field, 'today')"
                        appendTo="body" selectionMode="range" readonlyInput="true" [pTooltip]="calendarTooltip(col.field)" inputId="CalInput_{{col.field}}">
                    </p-calendar>
                    <input *ngSwitchDefault pInputText
                        attr.aria-label="Cella filtro per colonna {{col.label}}"
                        type="text"
                        (input)="dt.filter($event.target.value, col.field, col.filterMatchMode)"
                        #filterInputText>
                </div>
            </td>

        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowData let-attivita>
        <tr #selRow class="row-class" [pSelectableRow]="rowData" [pContextMenuRow]="rowData" style="height:30px" aria-label="riga">
            <td  aria-label="Colonna tipo attività" [style.width]="cols[0].width"  [style.minWidth]="cols[0].minWidth" [ngClass]="[columnClass, 'p0']">
                <img tabindex="0" role="button" *ngIf="!(attivita.tipo === 'notifica')" [src]="attivita.iconaAttivita" alt="icona priorità {{attivita.priorita}}" class="img-table" pTooltip="Imposta priorità" (click)="impostaPriorita(attivita, $event)"/>
                <img *ngIf="attivita.tipo === 'notifica'" [src]="attivita.iconaAttivita" alt="icona notifica" class="img-table" pTooltip="Notifica"/>
            </td>
            <td aria-label="Colonna Ente" *ngIf="(aziendeUser > 1) && !changedOrder" headers="idAzienda.nome" [style.width]="cols[1].width" [style.minWidth]="cols[1].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[1])}}</td>
            <td aria-label="Colonna Ente" *ngIf="changedOrder" headers="idAzienda.nome" [style.width]="cols[1].width" [style.minWidth]="cols[1].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[1])}}</td>
            <td aria-label="Colonna Applicazione" headers="idApplicazione.nome" [style.width]="cols[2].width" [style.minWidth]="cols[2].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[2])}}</td>
            <td aria-label="Colonna provenienza" headers="provenienza" [id]="attivita.id" #td3 [style.width]="cols[3].width" [style.minWidth]="cols[3].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[3], td3)}}</td>
            <td aria-label="Colonna oggetto" headers="oggetto" [style.width]="cols[4].width" [style.minWidth]="cols[4].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[4])}}</td>
            <td aria-label="Colonna Data" *ngIf="!changedOrder" headers="data" [style.width]="cols[5].width" [style.minWidth]="cols[5].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[5])}}</td>
            <td aria-label="Colonna Data" *ngIf="(aziendeUser > 1) && changedOrder" headers="data" [style.width]="cols[5].width" [style.minWidth]="cols[5].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[5])}}</td>
            <td aria-label="Colonna Tipo" headers="descrizione" [style.width]="cols[6].width" [style.minWidth]="cols[6].minWidth" [ngClass]="columnClass" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[6])}}</td>
            <td aria-label="Colonna Azione" headers="azione" [id]="attivita.id" #td7 [style.width]="cols[7].width" [style.minWidth]="cols[7].minWidth" [ngStyle]="!attivita.aperta ? {'font-weight':'bold'}: ''">{{getColumnValue(attivita, cols[7], td7)}}</td>
            <td aria-label="Colonna check procedibilità" [style.width]="cols[8].width" [style.minWidth]="cols[8].minWidth" class="p0">
                <img tabindex="0" *ngIf="attivita.datiAggiuntivi.custom_app_3 === '0'" src="assets/images/baseline-not_interested-24px.svg" alt="Sul documento mancano alcuni dati che devono essere inseriti prima di poter procedere." class="img-table"
                    pTooltip="Sul documento mancano alcuni dati che devono essere inseriti prima di poter procedere.">
            </td>
            <td aria-label="Colonna elimina notifica" [style.width]="cols[9].width" [style.minWidth]="cols[9].minWidth" class="p0 columns-icon">
                <span role="button" tabindex="0" *ngIf="attivita.tipo === 'notifica'" class="pi pi-trash" pTooltip="Elimina notifica" aria-label="icona elimina" (click)="deleteAttivita($event, rowData)"></span>
            </td>
            <td aria-label="Colonna note" [style.width]="cols[10].width" [style.minWidth]="cols[10].minWidth" class="p0">
                <img tabindex="0" *ngIf="attivita.note" src="assets/images/baseline-note-24px.svg" style="transform: rotate(90deg) scaleX(-1)" (click)="noteClicckato(attivita, $event)" alt="Leggi note" role="button" class="img-table" pTooltip="Leggi note">
                <img tabindex="0" *ngIf="!attivita.note" src="assets/images/outline-note_add-24px.svg" (click)="noteClicckato(attivita, $event)" alt="Inserisci note" role="button"  class="img-table" pTooltip="Inserisci note">
            </td>
            <td *ngIf="cols[11].visibility==='visible'" aria-label="Colonna Apri Anteprima" headers="anteprima" [style.width]="cols[11].width" 
                [style.cursor]="!attivita.allegatoDaMostrare ? 'auto' : 'pointer'"
                [style.minWidth]="cols[11].minWidth" class="p0 columns-icon" (click)="onClickSuApriAnteprima(attivita, $event)">
                <div *ngIf="attivita.allegatoDaMostrare && attivita.descrizione !== 'Redazione' && attivita.descrizione !== 'Bozza' ">
                        <!-- <div><i class="pi pi-file-pdf"></i></div> -->
                    <a style="color: #993366; cursor: pointer" aria-hidden="true" title="Apri stampa unica in una nuova finestra"><strong>Anteprima</strong></a>
                </div>
               <!--  <div *ngIf="attivita.antePrimaNonDisponibile" title="Anteprima non disponibile" style="width: 100%">
                    <div title="Anteprima non disponibile" style="width: 100%"></div>
                </div> -->
            </td>
        </tr>
    </ng-template>
</p-table>
<p-contextMenu #cm [model]="attivitaSelezionata?.aperta ? contextMenuAperte : contextMenuNonAperte" [ngClass]="'clContextMenu'" [style]="{'margin': '-130px 0 0 -30px'}"></p-contextMenu>

 <!-- ****  LE NOTE  **** -->
<p-dialog *ngIf="this.showNote && this.attivitaTemp" styleClass="dialogNote" #noteAttivita header="Note Attività" [(visible)]="this.showNote" [modal]="true" [responsive]="true" [minY]="70"
    [maximizable]="true" appendTo="body">
    <textarea tabindex="0" pInputTextarea class="note" placeholder="Inserisci note" [(ngModel)]="this.attivitaTemp.note"></textarea>
    <p-footer #footerNoteAttivita>
        <button tabindex="0" style="width: auto; min-width: 50px;" type="button" pButton icon="pi pi-check" label="Conferma" (click)="bottoneSalvaNote()" pTooltip="Salva" tooltipPosition="bottom" appendTo="body"></button>
        <button tabindex="0" style="width: auto; min-width: 50px;" type="button" pButton icon="pi pi-times" label="Anulla" (click)="chiudiNote()" pTooltip="Chiudi" tooltipPosition="bottom" appendTo="body"></button>
    </p-footer>
</p-dialog>
<!-- richiesta di conferma di chiusura senza salvare  -->
<p-confirmDialog #confermaUscita appendTo="body" header="Esci" icon="pi pi-exclamation-triangle" width="425" key="closeWithoutSaving">
    <p-footer>
        <button type="button" pButton icon="" label="Si" (click)="confermaUscita.accept()"></button>
        <button type="button" pButton icon="" label="No" (click)="confermaUscita.reject()"></button>
    </p-footer>
</p-confirmDialog>

<p-confirmDialog #confermaSalvataggio appendTo="body" header="Salva" icon="pi pi-exclamation-triangle" width="425" key="saveNotes">
    <p-footer>
        <button type="button" pButton icon="" label="Si" (click)="confermaSalvataggio.accept()"></button>
        <button type="button" pButton icon="" label="No" (click)="confermaSalvataggio.reject()"></button>
    </p-footer>
</p-confirmDialog>